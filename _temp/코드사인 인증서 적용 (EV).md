# 공개키, 개인키 암복호화 방식

암복호화 가능한 두개의 키가 쌍으로 존재함.

```
공캐키 암호화 --> 개인키로 복호화 : 데이터 보안에 중점
개인키 암호화 --> 공개키로 복호화 : 인증(신원확인)에 중점
```

### 인증기관에서 신원확인
인증기관에서 두개의 키 발급 (cer/crt, pfx)
- 공개키, 개인키 발급됨
- 공개키는 저장소에 등록됨

### 개발자 (코드서명)
cert 파일에서 pfx 파일 추출, 또는 pfx 파일 전달 받음
- 개인키를 이용해 암호화 (exe) 후 배포

### 사용자
공개키 저장소에서 공개키 획득 (윈도우 저장소)
- 공개키를 통해 (exe) 복호화 후 사용 (인증됨)

복호화 되었다는것은 공개키와 쌍을 이루는 개인키에의해 암호화 되었음을 뜻함.  
즉, exe 제공자의 신원 확인이 보장됨

# EV Code Signing 인증서
발급 → 서명 → 배포 → 검증 과정

|     구분	      | 일반 코드서명	   |         EV 코드서명         |
|:--------------:|--------------------|:---------------------------:|
|  개인키 저장   | 개발자 PC (PFX)    | `하드웨어 토큰 (USB, HSM)`  |
|   발급 대상    | 개인/기업          |         기업/법인만         |
|     보안성     | 개인키 유출 위험   |    개인키 외부 유출 불가    |
|  SmartScreen   | 평판 쌓아야 우회   |       즉시 우회 가능        |

## EV Code Signing 인증서 발급 절차

1. CA(공인 인증기관)에 신청
  - 대표적인 CA: DigiCert, Sectigo, GlobalSign 등.
  - EV 인증서는 법인 또는 등록된 사업자만 신청 가능 (개인 불가).

2. 기업 신원 검증 (Extended Validation)
  - 사업자 등록 정보 확인 (사업자등록증, Dun & Bradstreet 번호 등)
  - 전화 인증 (CA가 등록된 대표번호로 직접 전화)
  - 서류 확인 (계약서, 법적 서류 등)

3. 하드웨어 토큰(HSM/USB) 발급
  - EV 인증서는 `반드시 FIPS 140-2 인증 하드웨어 토큰에 저장`됩니다.
  - 예: SafeNet USB eToken, YubiKey HSM
  - 이유: 개인키(Private Key)를 절대 PC에 노출시키지 않기 위해서.

CA가 발급 시 USB 토큰(HSM)에 직접 심어주기 때문에
  - 개인키(Private Key)는 토큰 안에만 존재하고, 절대 꺼낼 수 없음.
  - 따라서 `.pfx`처럼 복사해서 다른 PC/사람에게 줄 수가 없음.
  - 원칙적으로는 하나의 USB 토큰에만 존재.
  - 개발자가 여러 명이라면 `토큰을 돌려쓰거나 서명 담당자만 전담`해야 함

여러 명이 서명해야 할 때
  - 추가 토큰 발급(Clone Token)을 요청 (여러 USB 토큰에 담아줌)
  - HSM 또는 `클라우드 코드사인 서비스` 사용
    + 클라우드 기반 HSM에 저장
    + 원격으로 서명 API를 호출

## EV 코드서명 과정 (개발자)

1. USB 토큰 연결
  - 서명할 때마다 토큰을 꽂고 PIN 입력 필요.
  - 토큰 안에 개인키가 저장되어 있고, 절대 꺼낼 수 없음.

2. 서명 툴 실행 (예: `signtool.exe`)
  - PIN 입력: 토큰 내부에서 서명 연산 수행
  - 결과적으로 실행파일에 디지털 서명이 들어감.

```
signtool sign /a  
              /sm                                   # 스마트카드/토큰 모드
              /n "Your Company Name"
              /tr "http://timestamp.digicert.com"   # /tr : 타임스탬프 서버 (중요)
              /td sha256                            # /td : 타임스탬프 다이제스트 알고리즘
              /fd sha256                            # /fd : 파일 다이제스트 알고리즘
              "MyApp.exe"
```

## 배포 & 사용자 측 검증

1. 사용자가 프로그램 다운로드/실행 시
  - Windows는 실행파일에 포함된 서명을 확인
  - 공개키 인증서(.cer 체인)로 검증 : EV 인증서는 CA 체인에 의해 신뢰 가능

2. SmartScreen 필터 동작
  - 일반 코드서명은 SmartScreen Reputation을 쌓아야 경고가 줄어듦.
  - 하지만 EV 인증서는 즉시 SmartScreen 우회 (Microsoft가 EV를 특별히 신뢰).

3. UAC 화면 표시
  - EV 인증서 서명된 경우: `신뢰할 수 있는 게시자: Your Company Name`
  - 미서명/자체서명인 경우: `알 수 없는 게시자`




